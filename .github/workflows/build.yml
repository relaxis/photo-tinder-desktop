  name: Build and Release

  on:
    push:
      tags:
        - 'v*'
    workflow_dispatch:

  jobs:
    build:
      strategy:
        fail-fast: false
        matrix:
          include:
            - platform: 'macos-latest'
              args: '--target aarch64-apple-darwin'
              name: 'macOS-arm64'
            - platform: 'macos-latest'
              args: '--target x86_64-apple-darwin'
              name: 'macOS-x64'
            - platform: 'ubuntu-22.04'
              args: ''
              name: 'Linux'
            - platform: 'windows-latest'
              args: ''
              name: 'Windows'

      runs-on: ${{ matrix.platform }}
      steps:
        - uses: actions/checkout@v4
        - uses: dtolnay/rust-action@stable
          with:
            targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}
        - if: matrix.platform == 'ubuntu-22.04'
          run: sudo apt-get update && sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
        - uses: actions/setup-node@v4
          with:
            node-version: 'lts/*'
        - run: npm install
        - uses: tauri-apps/tauri-action@v0
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            args: ${{ matrix.args }}
        - uses: actions/upload-artifact@v4
          with:
            name: photo-tinder-${{ matrix.name }}
            path: |
              src-tauri/target/**/release/bundle/**/*

